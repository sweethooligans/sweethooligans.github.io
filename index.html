<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sweet Hooligans – Map Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Minimal, stable CSS (no blur/filters) */
    html, body { height: 100%; margin: 0; background: #0b0b0d; color: #fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map { position: fixed; inset: 0; }
    .bar { position: fixed; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
           background: rgba(24,24,27,.8); border: 1px solid rgba(255,255,255,.15); border-radius: 12px; padding: 8px 10px; z-index: 10; }
    #top { top: 12px; }
    #bottom { bottom: 12px; }
    input[type="text"] { width: min(58vw, 520px); max-width: 90vw; background: rgba(255,255,255,.1); color: #fff; border: 1px solid rgba(255,255,255,.2);
                         border-radius: 10px; padding: 10px 12px; font-size: 16px; outline: none; }
    .btn { appearance: none; border: 1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.12); color: #fff; border-radius: 10px;
           padding: 10px 12px; font-weight: 600; font-size: 14px; cursor: pointer; }
    .btn.primary { background: #4CAF50; }
    .tabs { display: flex; gap: 6px; }
    .tab { padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.12); cursor: pointer; font-size: 13px; }
    .tab.active { background: #4CAF50; }
    .note { position: fixed; right: 12px; bottom: 12px; font-size: 12px; opacity: .8; background: rgba(24,24,27,.8); border: 1px solid rgba(255,255,255,.15);
            border-radius: 10px; padding: 6px 8px; z-index: 10; }
    .status { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); background: #d97706; color: #111; border-radius: 8px; padding: 6px 10px;
              border: 1px solid rgba(255,255,255,.2); display: none; z-index: 11; font-size: 13px; }
    @media (max-width: 640px){ input[type="text"]{ width: 58vw; } .tabs{ width:100%; justify-content:center; } }
  </style>
</head>
<body>
  <div id="map" role="application" aria-label="Map"></div>

  <div id="top" class="bar">
    <form id="address-form" style="display:contents">
      <input id="address" type="text" placeholder="Enter address (e.g., 1600 Pennsylvania Ave NW, DC)" />
      <button class="btn primary" type="submit">Search</button>
    </form>
    <div class="tabs" aria-label="Map Styles">
      <button class="tab active" data-style="style1">Style 1</button>
      <button class="tab" data-style="style2">Style 2</button>
      <button class="tab" data-style="style3">Style 3</button>
    </div>
  </div>

  <div id="bottom" class="bar">
    <button class="btn" id="zoomOut">−</button>
    <span id="zoomLevel" style="min-width:3ch;text-align:center">12</span>
    <button class="btn" id="zoomIn">+</button>
    <button class="btn" id="centerMarker">Center to Marker</button>
    <button class="btn primary" id="downloadBtn">Download PNG</button>
  </div>

  <div class="note">Tip: drag the ❤️ to fine-tune the location.</div>
  <div class="status" id="status"></div>

  <script>
    // ====== CONFIG (your new key + map IDs) ======
    const API_KEY = "AIzaSyBviIcXPutnW2Y49AxXduizoHy2_c9QEcI";
    const MAP_IDS = {
      style1: "49e651064b8ea8d6947bd49c",
      style2: "49e651064b8ea8d68e9a9d8b",
      style3: "49e651064b8ea8d625a41a78"
    };
    const HEART_ICON = "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f1/Heart_coraz%C3%B3n.svg/1920px-Heart_coraz%C3%B3n.svg.png";
    const DEFAULT_CENTER = { lat: 40.7128, lng: -74.0060 };
    const DEFAULT_ZOOM = 12;

    let map, marker, geocoder;
    let currentStyleKey = "style1";
    let tilesLoaded = false;

    function setStatus(msg){
      const s = document.getElementById('status');
      if(!msg){ s.style.display='none'; s.textContent=''; return; }
      s.textContent = msg;
      s.style.display = 'block';
    }

    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

    function buildStaticUrl(){
      const center = map.getCenter();
      const lat = center.lat(), lng = center.lng();
      const zoom = clamp(map.getZoom(), 0, 21);
      const rect = document.getElementById("map").getBoundingClientRect();
      const maxBase = 640, scale = 2;
      let w = Math.min(maxBase, Math.round(rect.width));  w = Math.max(320, w);
      let h = Math.min(maxBase, Math.round(rect.height)); h = Math.max(320, h);

      const params = new URLSearchParams({
        center: `${lat},${lng}`,
        zoom: String(zoom),
        size: `${w}x${h}`,
        scale: String(scale),
        format: "png",
        map_id: MAP_IDS[currentStyleKey],
        key: API_KEY
      });

      const p = marker.getPosition();
      const icon = encodeURIComponent(HEART_ICON);
      params.append("markers", `icon:${icon}|${p.lat()},${p.lng()}`);

      return `https://maps.googleapis.com/maps/api/staticmap?${params.toString()}`;
    }

    function createMap(styleKey, center, zoom, markerPos){
      tilesLoaded = false;
      setStatus(""); // clear banner

      map = new google.maps.Map(document.getElementById("map"), {
        center: center || DEFAULT_CENTER,
        zoom: zoom ?? DEFAULT_ZOOM,
        mapId: MAP_IDS[styleKey],
        mapTypeControl:false, streetViewControl:false, fullscreenControl:false, clickableIcons:false
      });

      google.maps.event.addListenerOnce(map, 'tilesloaded', () => {
        tilesLoaded = true;
        setStatus(""); // hide if showing
      });

      // If tiles still not loaded after 4s, show a helpful hint (but A & B passed, so this should be fine)
      setTimeout(()=>{
        if(!tilesLoaded){
          setStatus("If the map is blank: confirm the API key and these Map IDs are in the same project, referrers allow github.io, and no extensions are blocking tiles.");
        }
      }, 4000);

      marker = new google.maps.Marker({
        position: markerPos || center || DEFAULT_CENTER,
        map,
        draggable: true,
        icon: { url: HEART_ICON, scaledSize: new google.maps.Size(34,34) },
        title: "Drag me to adjust"
      });

      map.addListener("zoom_changed", () => {
        document.getElementById("zoomLevel").textContent = map.getZoom();
      });
    }

    // Google callback must be global
    window.initMap = function(){
      geocoder = new google.maps.Geocoder();
      createMap(currentStyleKey);

      // Address search
      document.getElementById("address-form").addEventListener("submit", (e)=>{
        e.preventDefault();
        const addr = document.getElementById("address").value.trim();
        if(!addr) return;
        geocoder.geocode({ address: addr }, (results, status)=>{
          if(status === "OK" && results[0]){
            const loc = results[0].geometry.location;
            map.panTo(loc);
            marker.setPosition(loc);
            if(map.getZoom() < 14) map.setZoom(14);
          }else{
            alert("Address not found: " + status);
          }
        });
      });

      // Tabs (switch styles by rebuilding map with the new mapId)
      document.querySelectorAll(".tab").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          if(btn.classList.contains("active")) return;
          document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
          currentStyleKey = btn.dataset.style;

          const c = map.getCenter(), z = map.getZoom(), mPos = marker.getPosition();
          createMap(currentStyleKey, c, z, mPos);
        });
      });

      // Zoom & center controls
      document.getElementById("zoomIn").addEventListener("click", ()=> map.setZoom(map.getZoom()+1));
      document.getElementById("zoomOut").addEventListener("click", ()=> map.setZoom(map.getZoom()-1));
      document.getElementById("centerMarker").addEventListener("click", ()=> map.panTo(marker.getPosition()));

      // Download PNG with same style via Static Maps
      document.getElementById("downloadBtn").addEventListener("click", ()=>{
        const url = buildStaticUrl();
        fetch(url).then(r=>r.blob()).then(blob=>{
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = `sweet-hooligans-map-${currentStyleKey.toUpperCase()}-${Date.now()}.png`;
          document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
        }).catch(()=>{ window.open(url, "_blank"); });
      });

      // Surface JS errors as a banner instead of silently failing
      window.addEventListener("error", (e)=>{
        setStatus("JS error: " + (e.message || "unknown"));
      });
    };
  </script>

  <!-- Load Google Maps after defining initMap -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBviIcXPutnW2Y49AxXduizoHy2_c9QEcI&callback=initMap&v=weekly" async defer></script>
</body>
</html>
