<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sweet Hooligans – Map Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Keep it simple and stable: no transforms, no blurs, no fancy effects */
    html, body { height: 100%; margin: 0; background: #0b0b0d; color: #fff;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    #map { width: 100%; height: 100vh; position: relative; background: #000; }
    .bar { position: absolute; left: 12px; right: 12px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
           background: rgba(24,24,27,.9); border: 1px solid rgba(255,255,255,.15); border-radius: 12px; padding: 8px 10px; z-index: 5; }
    #top { top: 12px; }
    #bottom { bottom: 12px; justify-content: center; }
    input[type="text"] { flex: 1 1 320px; max-width: 560px; background: rgba(255,255,255,.1); color: #fff; border: 1px solid rgba(255,255,255,.2);
                         border-radius: 10px; padding: 10px 12px; font-size: 16px; outline: none; }
    .btn { appearance: none; border: 1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.12); color: #fff; border-radius: 10px;
           padding: 10px 12px; font-weight: 600; font-size: 14px; cursor: pointer; }
    .btn.primary { background: #4CAF50; }
    .tabs { display: flex; gap: 6px; }
    .tab { padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,.2);
           background: rgba(255,255,255,.12); cursor: pointer; font-size: 13px; }
    .tab.active { background: #4CAF50; }
    .note { position: absolute; right: 12px; bottom: 70px; font-size: 12px; opacity: .85; background: rgba(24,24,27,.9);
            border: 1px solid rgba(255,255,255,.15); border-radius: 10px; padding: 6px 8px; z-index: 5; }
  </style>
</head>
<body>
  <div id="map" aria-label="Map"></div>

  <div id="top" class="bar">
    <form id="address-form" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; width:100%">
      <input id="address" type="text" placeholder="Enter address (e.g., 1600 Pennsylvania Ave NW, DC)" />
      <button class="btn primary" type="submit">Search</button>
      <div class="tabs" aria-label="Map Styles">
        <button class="tab active" data-style="style1" type="button">Style 1</button>
        <button class="tab" data-style="style2" type="button">Style 2</button>
        <button class="tab" data-style="style3" type="button">Style 3</button>
      </div>
    </form>
  </div>

  <div id="bottom" class="bar">
    <button class="btn" id="zoomOut" type="button">−</button>
    <span id="zoomLevel" style="min-width:3ch;text-align:center">12</span>
    <button class="btn" id="zoomIn" type="button">+</button>
    <button class="btn" id="centerMarker" type="button">Center to Marker</button>
    <button class="btn primary" id="downloadBtn" type="button">Download PNG</button>
  </div>

  <div class="note">Tip: drag the ❤️ to fine-tune the location.</div>

  <script>
    // ===== CONFIG: your new key + Map IDs =====
    const API_KEY = "AIzaSyBviIcXPutnW2Y49AxXduizoHy2_c9QEcI";
    const MAP_IDS = {
      style1: "49e651064b8ea8d6947bd49c",
      style2: "49e651064b8ea8d68e9a9d8b",
      style3: "49e651064b8ea8d625a41a78"
    };
    const HEART_ICON = "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f1/Heart_coraz%C3%B3n.svg/1920px-Heart_coraz%C3%B3n.svg.png";
    const DEFAULT_CENTER = { lat: 40.7128, lng: -74.0060 };
    const DEFAULT_ZOOM = 12;

    let map, marker, geocoder;
    let currentStyleKey = "style1";

    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

    // Build Static Maps URL for PNG download (uses same map_id as live map)
    function buildStaticUrl(){
      const c = map.getCenter(), z = clamp(map.getZoom(), 0, 21);
      const rect = document.getElementById("map").getBoundingClientRect();
      const maxBase = 640, scale = 2;
      let w = Math.min(maxBase, Math.round(rect.width));  w = Math.max(320, w);
      let h = Math.min(maxBase, Math.round(rect.height)); h = Math.max(320, h);

      const params = new URLSearchParams({
        center: `${c.lat()},${c.lng()}`,
        zoom: String(z),
        size: `${w}x${h}`,
        scale: String(scale),
        format: "png",
        map_id: MAP_IDS[currentStyleKey],
        key: API_KEY
      });
      const p = marker.getPosition();
      const icon = encodeURIComponent(HEART_ICON);
      params.append("markers", `icon:${icon}|${p.lat()},${p.lng()}`);
      return `https://maps.googleapis.com/maps/api/staticmap?${params.toString()}`;
    }

    function switchStyle(styleKey){
      currentStyleKey = styleKey;
      // Safest way: update mapId live (no re-creation)
      map.setOptions({ mapId: MAP_IDS[styleKey] });
      // keep center/zoom/marker as-is
    }

    // Global callback for Google loader
    window.initMap = function(){
      geocoder = new google.maps.Geocoder();

      map = new google.maps.Map(document.getElementById("map"), {
        center: DEFAULT_CENTER,
        zoom: DEFAULT_ZOOM,
        mapId: MAP_IDS[currentStyleKey],
        clickableIcons: false,
        gestureHandling: "greedy",
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false
      });

      marker = new google.maps.Marker({
        position: DEFAULT_CENTER,
        map,
        draggable: true,
        icon: { url: HEART_ICON, scaledSize: new google.maps.Size(34,34) },
        title: "Drag me to adjust"
      });

      map.addListener("zoom_changed", () => {
        document.getElementById("zoomLevel").textContent = map.getZoom();
      });

      // Address search
      document.getElementById("address-form").addEventListener("submit", (e)=>{
        e.preventDefault();
        const addr = document.getElementById("address").value.trim();
        if (!addr) return;
        geocoder.geocode({ address: addr }, (results, status)=>{
          if (status === "OK" && results[0]){
            const loc = results[0].geometry.location;
            map.panTo(loc);
            marker.setPosition(loc);
            if (map.getZoom() < 14) map.setZoom(14);
          } else {
            alert("Address not found: " + status);
          }
        });
      });

      // Style tabs (update mapId in-place)
      document.querySelectorAll(".tab").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          if (btn.classList.contains("active")) return;
          document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
          switchStyle(btn.dataset.style);
        });
      });

      // Zoom/center controls
      document.getElementById("zoomIn").addEventListener("click", ()=> map.setZoom(map.getZoom()+1));
      document.getElementById("zoomOut").addEventListener("click", ()=> map.setZoom(map.getZoom()-1));
      document.getElementById("centerMarker").addEventListener("click", ()=> map.panTo(marker.getPosition()));

      // Download PNG (Static Maps)
      document.getElementById("downloadBtn").addEventListener("click", ()=>{
        const url = buildStaticUrl();
        fetch(url).then(r=>r.blob()).then(blob=>{
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = `sweet-hooligans-map-${currentStyleKey.toUpperCase()}-${Date.now()}.png`;
          document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(a.href);
        }).catch(()=>{ window.open(url, "_blank"); });
      });

      // Ensure proper sizing if viewport changes
      window.addEventListener("resize", ()=> google.maps.event.trigger(map, "resize"));
    };
  </script>

  <!-- Load Google Maps after defining initMap (no v=weekly; use stable channel) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBviIcXPutnW2Y49AxXduizoHy2_c9QEcI&callback=initMap" async defer></script>
</body>
</html>
